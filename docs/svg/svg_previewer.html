<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Optimized NFT SVG Previewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
        }

        .ui-button.selected {
            border-color: #6366F1;
            background-color: #4B5563;
        }
    </style>
</head>

<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen">

    <div class="w-full max-w-6xl mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-100">Optimized NFT Previewer</h1>
            <p class="text-gray-400 mt-2">Now with native SVG Text (No foreignObject) & Optimized Paths.</p>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Controls -->
            <div class="bg-gray-800 p-6 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-semibold mb-6 border-b border-gray-700 pb-3">Customization</h2>
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Mood</label>
                        <div id="emoji-selector" class="flex flex-wrap gap-2"></div>
                    </div>

                    <div>
                        <label for="text" class="block text-sm font-medium text-gray-300 mb-2">Journal Text</label>
                        <textarea id="text" rows="8"
                            class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-indigo-500 transition">This text is now rendered using native SVG elements. It will calculate line wrapping automatically without using HTML divs. This ensures your NFT renders correctly on OpenSea, Blur, and mobile Wallets.</textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Background Texture</label>
                        <div id="background-selector" class="flex flex-wrap gap-2"></div>
                    </div>
                </div>
            </div>

            <!-- Preview -->
            <div class="bg-gray-800 p-6 rounded-2xl shadow-lg flex flex-col items-center justify-center">
                <h2 class="text-2xl font-semibold mb-6 text-center">Live Preview</h2>
                <div id="svg-preview" class="w-full h-full aspect-square flex items-center justify-center shadow-2xl">
                    <!-- SVG injected here -->
                </div>
                <div class="flex gap-4 mt-6">
                    <button id="export-svg-button"
                        class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg transition">
                        Export SVG
                    </button>
                    <div class="text-xs text-gray-500 flex items-center">
                        <span id="byte-size">0 KB</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const textInput = document.getElementById('text');
        const svgPreview = document.getElementById('svg-preview');
        const emojiSelector = document.getElementById('emoji-selector');
        const backgroundSelector = document.getElementById('background-selector');
        const exportButton = document.getElementById('export-svg-button');
        const byteSizeDisplay = document.getElementById('byte-size');

        // 1. COMPRESSED PATH DATA (Simulating optimization)
        // I removed whitespace and fixed huge decimals for the Rabbit to save bytes
        const rabbitPath = "M639 775c-11.7 0-22.8 0-34 0-4.7 0-8.7-1.1-12-4.9-16.5-18.8-32-38.4-47.8-57.7-1.9-2.3-1.2-4.6-.6-7 3.9-17.2 3.3-34-3.9-50.4-10.9-24.8-35.8-41.4-61.4-40.6-7 .2-14 2-17.3 4.7 6.7 1 13.2 1.3 19.4 2.8 27.5 6.9 47 22.7 53.1 51.5 4.5 21.4-2.4 40.1-16.5 56.3-2.8 3.2-6.3 5.7-9.5 8.5.3.6.6 1.2 1 1.8 5.8 0 11.5-.2 17.3 0 19.7.6 34.1 10.9 40.6 28.6.6 1.6 1.2 3.1 1 5-1.8 1.8-4.2 1.4-6.5 1.4-37.2 0-74.3 0-111.5 0-14.7 0-29.2-1.2-42.2-9.5-14.9-9.4-24.6-22.9-30.3-39.2-13.4-37.9-8.1-74.2 11.1-108.7 18-32.5 45.5-55.3 77.2-73.6 10.8-6.3 22.2-11.4 33.7-16.2 1.4-.6 2.7-1.4 5-.8 2.5 8.4 6.1 16.7 11.3 24.3 16.1 23.5 38.9 35.6 66.6 39.6 7.5 1.1 15 1.4 22.5.9 4.4-.3 5.9 1.5 6.1 5.6 1.3 24.1-2.7 47.1-16 67.4-5.3 8-5.7 15.4-3.6 23.8 4.1 16.4 10.4 32 18.9 46.6 2.2 3.7 5 5.2 9.2 5.6 16.8 1.6 29.8 12.6 34.9 28.7 1.3 4.2 0 5.5-4 5.5-3.6-.1-7.3 0-11.5 0zM614 453c16 7.2 28.1 18.3 37.5 32.5 8.4 12.7 15.7 25.9 21.1 40.2 1.6 4.1 1.5 7.9 0 12-7.1 19.3-19.2 32.9-40.1 38.2-28.3 7.2-55.8 7.2-81.9-7.4-22.2-12.4-35.2-31.3-36.4-57.1-.6-13 2.1-25.9 6.4-38.2 1.6-4.7.7-7.6-2.9-10.8-17.1-15-32.7-31.3-46.5-49.4-17.6-23.2-27.9-49.4-32.6-78-3.5-21-3.7-42-1-63.1.3-2.3.5-4.6 2.1-6.7 4 .6 6.9 3.2 10 5.3 28.7 18.9 53.4 41.9 72.5 70.7 14.4 21.7 22.3 46 28.9 70.9 2.5 9.5 4.6 19.1 6.5 28.7.8 4.1 2.3 5.5 6.6 5 17.1-2.1 33.5.4 49.7 7.2zm-10 62c1.4-.8 3-1.5 4.3-2.5 5.6-4.4 7.4-12.8 4.2-19.4-2.9-6.1-10.1-9.5-16.6-8-9.4 2.2-14.4 9.9-12.4 18.9 1.8 8.1 10.6 13.1 20.5 11zm-8.8-161c5.5 26.2 6.2 52.2 3.9 78.4-.3 3.8-1.7 5.9-6.1 4.5-6.7-2.2-13.8-1.8-20.7-2.2-4.2-.2-5.7-1.9-6.5-5.7-3.7-17.2-8.2-34.3-14-51-5.3-15.5-12.4-30.2-21.4-43.9-3.2-5-4.9-9.9-4.9-15.8 0-19 .5-37.9 5.4-56.4.5-1.7 1.1-3.4 1.6-5.1 17.6 3.1 54.3 59.8 62.7 97.2zM366.5 727.6c4.8 13.5 11.9 25.2 21.2 36.5-8.2 3.8-16.2 5.2-24.2 4.6-29.9-2.3-49.3-28.5-38.6-61.4 1-3 2.8-5.1 5.9-6.2 8.4-3.1 16.9-3.3 25.5-1 3.1.8 4.8 2.5 5.1 5.8.6 7.3 2.8 14.3 5.1 21.7z";

        const backgrounds = {
            'Bob': {
                defs: `<linearGradient gradientTransform="rotate(-202, .5, .5)" x1="50%" y1="0" x2="50%" y2="100%" id="g2-bob"><stop stop-color="#ff9500" offset="0"/><stop stop-color="#fff" stop-opacity="0" offset="1"/></linearGradient><linearGradient gradientTransform="rotate(202, .5, .5)" x1="50%" y1="0" x2="50%" y2="100%" id="g3-bob"><stop stop-color="#f9f7f1"/><stop stop-color="#fff" stop-opacity="0" offset=".4"/></linearGradient><filter id="f-bob" x="-20%" y="-20%" width="140%" height="140%"><feTurbulence type="fractalNoise" baseFrequency=".9" seed="2" stitchTiles="stitch"/><feColorMatrix type="saturate" values="0"/><feComponentTransfer><feFuncR type="linear" slope="1.5"/><feFuncG type="linear" slope="1.5"/><feFuncB type="linear" slope="1.5"/></feComponentTransfer><feColorMatrix values="1 0 0 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 20 -12"/></filter>`,
                content: `<rect x="8" y="8" width="484" height="484" rx="15" fill="#f25d00"/><rect x="8" y="8" width="484" height="484" rx="15" fill="url(#g3-bob)"/><rect x="8" y="8" width="484" height="484" rx="15" fill="url(#g2-bob)"/><rect x="8" y="8" width="484" height="484" rx="15" fill="transparent" filter="url(#f-bob)" opacity=".66" style="mix-blend-mode:soft-light"/>`
            },
            'Base': {
                defs: `<linearGradient gradientTransform="rotate(-202, .5, .5)" x1="50%" y1="0" x2="50%" y2="100%" id="g2-base"><stop stop-color="#3c8aff" offset="0"/><stop stop-color="#fff" stop-opacity="0" offset="1"/></linearGradient><linearGradient gradientTransform="rotate(202, .5, .5)" x1="50%" y1="0" x2="50%" y2="100%" id="g3-base"><stop stop-color="#f9f7f1"/><stop stop-color="#fff" stop-opacity="0" offset=".4"/></linearGradient><filter id="f-base" x="-20%" y="-20%" width="140%" height="140%"><feTurbulence type="fractalNoise" baseFrequency=".9" seed="2" stitchTiles="stitch"/><feColorMatrix type="saturate" values="0"/><feComponentTransfer><feFuncR type="linear" slope="1.5"/><feFuncG type="linear" slope="1.5"/><feFuncB type="linear" slope="1.5"/></feComponentTransfer><feColorMatrix values="1 0 0 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 20 -12"/></filter>`,
                content: `<rect x="8" y="8" width="484" height="484" rx="15" fill="#00f"/><rect x="8" y="8" width="484" height="484" rx="15" fill="url(#g3-base)"/><rect x="8" y="8" width="484" height="484" rx="15" fill="url(#g2-base)"/><rect x="8" y="8" width="484" height="484" rx="15" fill="transparent" filter="url(#f-base)" opacity=".66" style="mix-blend-mode:soft-light"/>`
            },
            'Vellum': {
                defs: `<filter id="f-vellum" x="-20%" y="-20%" width="140%" height="140%"><feTurbulence type="fractalNoise" baseFrequency=".05" numOctaves="4" seed="15" stitchTiles="stitch" result="noise"/><feDiffuseLighting in="noise" lighting-color="#FFFAF0" surfaceScale="1.5" result="lit"><feDistantLight azimuth="235" elevation="60"/></feDiffuseLighting><feBlend in="SourceGraphic" in2="lit" mode="multiply"/></filter>`,
                content: `<rect x="8" y="8" width="484" height="484" rx="15" fill="#f25d00"/><rect x="8" y="8" width="484" height="484" rx="15" fill="#ff9500" opacity=".25" filter="url(#f-vellum)"/>`
            },
            'HyperLiquid': {
                defs: ``,
                content: `<rect x="8" y="8" width="484" height="484" rx="15" fill="#0F2925"/>`
            },
            'Classic': {
                defs: ``,
                content: `<rect x="8" y="8" width="484" height="484" rx="15" fill="#F9F7F1"/>`
            },
            'MegaETH': {
                defs: `<linearGradient gradientTransform="rotate(-202, .5, .5)" x1="50%" y1="0" x2="50%" y2="100%" id="g2-mega"><stop stop-color="#AAA" offset="0"/><stop stop-color="#fff" stop-opacity="0" offset="1"/></linearGradient><linearGradient gradientTransform="rotate(202, .5, .5)" x1="50%" y1="0" x2="50%" y2="100%" id="g3-mega"><stop stop-color="#555"/><stop stop-color="#fff" stop-opacity="0" offset=".4"/></linearGradient><filter id="f-mega" x="-20%" y="-20%" width="140%" height="140%"><feTurbulence type="fractalNoise" baseFrequency=".9" seed="2" stitchTiles="stitch"/><feColorMatrix type="saturate" values="0"/><feComponentTransfer><feFuncR type="linear" slope="1.5"/><feFuncG type="linear" slope="1.5"/><feFuncB type="linear" slope="1.5"/></feComponentTransfer><feColorMatrix values="1 0 0 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 20 -12"/></filter>`,
                content: `<rect x="8" y="8" width="484" height="484" rx="15" fill="#111"/><rect x="8" y="8" width="484" height="484" rx="15" fill="url(#g3-mega)"/><rect x="8" y="8" width="484" height="484" rx="15" fill="url(#g2-mega)"/><rect x="8" y="8" width="484" height="484" rx="15" fill="transparent" filter="url(#f-mega)" opacity=".66" style="mix-blend-mode:soft-light"/>`
            },
            'INK': {
                defs: ``,
                content: `<g transform="translate(8, 8) scale(0.968)"><rect width="500" height="500" fill="#5848d5"/><path d="M0,0L500,0v100.43c0-48.29-60.95-41.79-60.95,0v234.04c0,65.01-83.58,65.94-84.51,0v-255.4c0-36.68-54.79-34.51-54.79,0v112.38c0,58.55-79.87,58.55-79.87,0v-91.01c0-37.15-73.67-37.15-73.67,0v162.53c0,66.87-97.83,66.87-97.83,0v-162.53c0-35.22-48.37-35.22-48.37,0" fill="#0d0c52"/></g>`
            }
        };

        const emojis = ['üòÑ', 'üòç', 'ü§î', 'üò¢', 'üò†', 'üéâ', 'üöÄ', 'üí°', 'üôè', 'üî•'];
        let selectedMood = emojis[0];
        let selectedBackground = Object.keys(backgrounds)[0];

        // 2. NATIVE SVG WORD WRAPPING
        // This algorithm calculates line breaks without using the DOM
        // Estimated char widths are used to prevent foreignObject usage
        function wrapText(text, maxWidth, fontSize) {
            const words = text.split(' ');
            const lines = [];
            let currentLine = words[0];

            // Approximation of character width (average aspect ratio of font)
            // standard sans-serif char width is roughly 0.6 * fontSize
            const charWidth = fontSize * 0.55;

            for (let i = 1; i < words.length; i++) {
                const word = words[i];
                const width = (currentLine.length + 1 + word.length) * charWidth;
                if (width < maxWidth) {
                    currentLine += " " + word;
                } else {
                    lines.push(currentLine);
                    currentLine = word;
                }
            }
            lines.push(currentLine);
            return lines;
        }

        function escapeString(str) {
            if (!str) return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&apos;');
        }

        function generateSVG(entry, backgroundDef, backgroundName) {
            const escapedMood = escapeString(entry.mood);
            const blockNumber = entry.blockNumber;
            const footerText = backgroundName.toUpperCase();

            // Theme Configuration
            let tColor = 'white', mColor = 'white', bColor = 'white', fColor = 'white';
            let brandColor = 'white', emojiColor = 'white', lColor = 'white';
            let lOpac = 0.3;
            let tShadow = 'filter: drop-shadow(1px 1px 1px rgba(0,0,0,0.5))'; // Use filter instead of text-shadow CSS
            let font = 'Arial, sans-serif';

            if (backgroundName === 'HyperLiquid') {
                bColor = '#8DFADF'; fColor = '#8DFADF'; brandColor = '#f9f7f1';
            } else if (backgroundName === 'Classic') {
                tColor = '#2D2D2D'; mColor = '#5A5A5A'; bColor = '#8B7355';
                fColor = '#8B7355'; brandColor = '#8B7355'; emojiColor = '#2D2D2D';
                tShadow = '';
                font = 'Georgia, serif'; lColor = '#5A5A5A'; lOpac = 0.5;
            } else if (backgroundName === 'MegaETH') {
                lColor = '#AAA'; lOpac = 0.25;
            } else if (backgroundName === 'INK') {
                bColor = '#21c7f9'; fColor = '#21c7f9'; brandColor = '#21c7f9';
            }

            // Text Wrapping Logic
            const fontSize = 18;
            const lineHeight = 26;
            const textAreaWidth = 380; // slightly narrower to be safe
            const lines = wrapText(entry.text, textAreaWidth, fontSize);
            const totalHeight = lines.length * lineHeight;
            const startY = 250 - (totalHeight / 2); // Vertically center

            // Generate TSpan elements
            const textContent = lines.map((line, i) =>
                `<tspan x="250" dy="${i === 0 ? 0 : lineHeight}">${escapeString(line)}</tspan>`
            ).join('');

            // 3. MINIFIED STRUCTURE
            // Removing extraneous groups and using direct attributes where possible
            return `
<svg width="100%" height="100%" viewBox="0 0 500 500" xmlns="http://www.w3.org/2000/svg">
    <defs>
        <style>

            .shadow { filter: drop-shadow(4px 4px 5px rgba(0,0,0,0.4)); }
            text { font-family: ${font}; }
        </style>
        ${backgroundDef.defs}
        <clipPath id="clip"><rect x="8" y="8" width="484" height="484" rx="15" /></clipPath>

    </defs>
    
    <rect x="8" y="8" width="484" height="484" rx="15" fill="none" class="shadow" />

    <g clip-path="url(#clip)">
        ${backgroundDef.content}
        ${backgroundName === 'MegaETH' ? `
            <g transform="translate(-194.6, -213.5) scale(0.9)" fill="${lColor}" fill-opacity="${lOpac}" style="pointer-events:none">
                <path d="${rabbitPath}"/>
            </g>` : ''}
        
        <!-- Metadata -->
        <text x="450" y="90" font-size="70" text-anchor="end" fill="${emojiColor}">${escapedMood}</text>
        <text x="35" y="45" font-family="monospace" font-size="14" fill="${mColor}" fill-opacity="0.7">minted on block</text>
        <text x="35" y="65" font-family="monospace" font-size="16" fill="${bColor}" fill-opacity="0.8">#${blockNumber}</text>

        <!-- Main Text (Native SVG) -->
        <text x="250" y="${startY + (fontSize / 2)}" font-size="${fontSize}" fill="${tColor}" text-anchor="middle" style="${tShadow}">
            ${textContent}
        </text>

        <!-- Footer -->
        <text x="35" y="475" font-family="monospace" font-size="16" fill="${fColor}" fill-opacity="0.7">${footerText}</text>
        <text x="465" y="475" font-family="monospace" font-size="16" fill="${brandColor}" fill-opacity="0.7" text-anchor="end">MintMyMood</text>
    </g>
</svg>`;
        }

        function updatePreview() {
            const entry = {
                mood: selectedMood,
                text: textInput.value,
                blockNumber: Math.floor(100000 + Math.random() * 900000)
            };
            const backgroundDef = backgrounds[selectedBackground];
            const svgString = generateSVG(entry, backgroundDef, selectedBackground);
            svgPreview.innerHTML = svgString;

            // Calculate byte size
            const blob = new Blob([svgString]);
            byteSizeDisplay.innerText = (blob.size / 1024).toFixed(2) + ' KB';
        }

        function setupControls() {
            emojis.forEach(emoji => {
                const button = document.createElement('button');
                button.textContent = emoji;
                button.className = `ui-button p-2 rounded-lg text-2xl transition border-2 bg-gray-700 border-transparent hover:bg-gray-600 ${emoji === selectedMood ? 'selected' : ''}`;
                button.addEventListener('click', () => {
                    selectedMood = emoji;
                    document.querySelectorAll('#emoji-selector .ui-button').forEach(btn => btn.classList.remove('selected'));
                    button.classList.add('selected');
                    updatePreview();
                });
                emojiSelector.appendChild(button);
            });

            Object.keys(backgrounds).forEach(name => {
                const button = document.createElement('button');
                button.textContent = name;
                button.className = `ui-button px-4 py-2 rounded-lg text-md transition border-2 bg-gray-700 border-transparent hover:bg-gray-600 ${name === selectedBackground ? 'selected' : ''}`;
                button.addEventListener('click', () => {
                    selectedBackground = name;
                    document.querySelectorAll('#background-selector .ui-button').forEach(btn => btn.classList.remove('selected'));
                    button.classList.add('selected');
                    updatePreview();
                });
                backgroundSelector.appendChild(button);
            });
        }

        function handleExport() {
            const svgData = svgPreview.innerHTML;
            const blob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'mint-my-mood.svg';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        textInput.addEventListener('input', updatePreview);
        exportButton.addEventListener('click', handleExport);
        document.addEventListener('DOMContentLoaded', () => {
            setupControls();
            updatePreview();
        });
    </script>
</body>

</html>